<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RWA Tranche Protocol (Pro)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        /* v2.0 æ ·å¼å‡çº§ï¼šæ›´ç»†è…»çš„äº¤äº’åé¦ˆ */
        :root { --primary: #238636; --danger: #da3633; --bg: #0d1117; --card-bg: #161b22; --border: #30363d; --text: #c9d1d9; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, sans-serif; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; }
        .container { max-width: 500px; width: 100%; animation: fadeIn 0.5s ease; }
        h1 { color: #58a6ff; text-align: center; margin-bottom: 5px; font-size: 1.5rem; }
        .subtitle { text-align: center; color: #8b949e; font-size: 0.9rem; margin-bottom: 20px; }
        
        /* å¡ç‰‡æ ·å¼ */
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .card:hover { border-color: #58a6ff; }
        
        /* æ•°æ®è¡Œ */
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .label { font-size: 0.85em; color: #8b949e; }
        .value { font-size: 1.1em; font-weight: 600; color: #fff; font-variant-numeric: tabular-nums; }
        .highlight { color: #58a6ff; }
        
        /* æŒ‰é’®æ ·å¼ */
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.95rem; display: flex; justify-content: center; align-items: center; gap: 8px; }
        button:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }
        .btn-connect { background: transparent; border: 1px solid var(--border); color: #58a6ff; margin-bottom: 20px; }
        .btn-connect:hover { background: rgba(88, 166, 255, 0.1); }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #2ea043; transform: translateY(-1px); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #f85149; transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover:not(:disabled) { border-color: #8b949e; }

        /* è¾“å…¥æ¡†åŒºåŸŸ */
        .input-group { position: relative; margin-bottom: 15px; }
        input { width: 100%; padding: 12px; padding-right: 60px; background: #010409; border: 1px solid var(--border); color: white; border-radius: 8px; box-sizing: border-box; font-size: 1rem; outline: none; transition: border 0.2s; }
        input:focus { border-color: #58a6ff; }
        .unit { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #8b949e; font-size: 0.9rem; pointer-events: none; }
        
        /* ä½™é¢æ˜¾ç¤º */
        .balance-display { font-size: 0.8rem; text-align: right; color: #8b949e; margin-top: -10px; margin-bottom: 15px; cursor: pointer; }
        .balance-display:hover { color: #58a6ff; text-decoration: underline; }

        /* çŠ¶æ€æ  */
        #status { min-height: 24px; text-align: center; font-size: 0.9rem; margin-top: 10px; border-radius: 6px; padding: 8px; opacity: 0; transition: opacity 0.3s; }
        .status-show { opacity: 1 !important; }
        .status-loading { color: #f0883e; background: rgba(240, 136, 62, 0.1); }
        .status-success { color: #238636; background: rgba(35, 134, 54, 0.1); }
        .status-error { color: #da3633; background: rgba(218, 54, 51, 0.1); }

        /* åŠ¨ç”» */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
        .loading .spinner { display: block; }
    </style>
</head>
<body>

    <div class="container">
        <h1>RWA Tranche Protocol</h1>
        <div class="subtitle">Decentralized Structured Finance on Sepolia</div>
        
        <button id="connectBtn" class="btn-connect" onclick="init()">
            <span>ğŸ”Œ è¿æ¥é’±åŒ… (Connect Wallet)</span>
        </button>

        <div class="card">
            <div class="row">
                <span class="label">ğŸ”µ Senior TVL (ç¨³å¥å±‚)</span>
                <span class="value" id="seniorTvl">--</span>
            </div>
            <div class="row">
                <span class="label">ğŸ”´ Junior TVL (æ¿€è¿›å±‚)</span>
                <span class="value" id="juniorTvl">--</span>
            </div>
            <div style="height: 1px; background: var(--border); margin: 10px 0;"></div>
            <div class="row">
                <span class="label">æˆ‘çš„é’±åŒ…ä½™é¢ (My Balance)</span>
                <span class="value highlight" id="myUsdtBalance">--</span>
            </div>
        </div>

        <div class="card">
            <div class="row">
                <h3 style="margin:0; font-size: 1.1rem;">ğŸ¦ å­˜æ¬¾ (Deposit)</h3>
                <span class="label">APY: <span style="color:#238636">5%</span> / Float</span>
            </div>
            
            <div class="input-group">
                <input type="number" id="depositAmount" placeholder="0.0" oninput="validateAmount()">
                <span class="unit">USDT</span>
            </div>
            <div class="balance-display" onclick="fillMax()">
                å¯ç”¨: <span id="clickableBalance">0.0</span> USDT (ç‚¹å‡»æœ€å¤§)
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" id="btnSenior" onclick="handleDeposit(0)">
                    <div class="spinner"></div> <span>å­˜å…¥ Senior</span>
                </button>
                <button class="btn-danger" id="btnJunior" onclick="handleDeposit(1)">
                    <div class="spinner"></div> <span>å­˜å…¥ Junior</span>
                </button>
            </div>
        </div>

        <div class="card">
            <div class="row">
                <h3 style="margin:0; font-size: 1.1rem;">ğŸ’° èµå› (Redeem)</h3>
            </div>
            <p style="font-size: 0.85em; color: #8b949e; margin-top: 5px;">åªæœ‰åœ¨ç®¡ç†å‘˜ç»“ç®—åæ–¹å¯èµå›æœ¬é‡‘ä¸æ”¶ç›Šã€‚</p>
            <button class="btn-outline" id="btnWithdraw" onclick="handleWithdraw()">
                <div class="spinner"></div> <span>æå–æ‰€æœ‰èµ„é‡‘</span>
            </button>
        </div>

        <div class="card" style="border-color: rgba(218, 54, 51, 0.3);">
            <div class="row">
                <h3 style="margin:0; font-size: 1.1rem; color: #f85149;">âš¡ ç®¡ç†å‘˜é¢æ¿</h3>
            </div>
            <button class="btn-danger" id="btnClose" onclick="handleCloseRound()" style="background: rgba(218, 54, 51, 0.1); border: 1px solid var(--danger); color: var(--danger);">
                <div class="spinner"></div> <span>ğŸš¨ ç»“ç®—å‘¨æœŸ (Settlement)</span>
            </button>
        </div>

        <div id="status"></div>
    </div>

    <script>
        // ================= é…ç½®åŒºåŸŸ (è¯·ä¿®æ”¹è¿™é‡Œ) =================
        const USDT_ADDRESS = "0x3eC21aa2b56E843b3641C74e8D12d66Bd0C919ff"; 
        const VAULT_ADDRESS = "0xbd6B25948eB056074A60C3A79ae467E3C0053c2d";
        // ======================================================

        const USDT_ABI = [
            "function approve(address spender, uint256 value) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function balanceOf(address account) external view returns (uint256)" // æ–°å¢ï¼šæŸ¥ä½™é¢
        ];
        
        const VAULT_ABI = [
            "function deposit(uint256 amount, uint8 trancheType) external",
            "function withdraw() external",
            "function closeRoundAndDistribute() external",
            "function totalSeniorDeposit() view returns (uint256)",
            "function totalJuniorDeposit() view returns (uint256)"
        ];

        let provider, signer, usdtContract, vaultContract, userAddress;
        let userBalanceWei = 0n; // å­˜å‚¨ç”¨æˆ·ä½™é¢ (BigInt)

        async function init() {
            if (!window.ethereum) return alert("è¯·å®‰è£… MetaMask!");
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                // UI æ›´æ–°
                const btn = document.getElementById("connectBtn");
                btn.innerHTML = `<span>âœ… å·²è¿æ¥: ${userAddress.slice(0,6)}...${userAddress.slice(-4)}</span>`;
                btn.classList.add("btn-outline");
                
                // åˆçº¦åˆå§‹åŒ–
                usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, signer);
                vaultContract = new ethers.Contract(VAULT_ADDRESS, VAULT_ABI, signer);

                await refreshData();
                showStatus("âœ… é’±åŒ…è¿æ¥æˆåŠŸ", "success");
            } catch (err) {
                console.error(err);
                showStatus("âŒ è¿æ¥å¤±è´¥: " + err.message, "error");
            }
        }

        async function refreshData() {
            if (!usdtContract || !vaultContract) return;
            try {
                // å¹¶è¡Œè¯»å–æ•°æ®ä»¥åŠ å¿«é€Ÿåº¦
                const [sTvl, jTvl, bal] = await Promise.all([
                    vaultContract.totalSeniorDeposit(),
                    vaultContract.totalJuniorDeposit(),
                    usdtContract.balanceOf(userAddress)
                ]);

                userBalanceWei = bal; // å­˜ä¸‹æ¥æ–¹ä¾¿è®¡ç®—

                // æ ¼å¼åŒ–
                document.getElementById("seniorTvl").innerText = formatUSDT(sTvl) + " U";
                document.getElementById("juniorTvl").innerText = formatUSDT(jTvl) + " U";
                
                const balFormatted = formatUSDT(bal);
                document.getElementById("myUsdtBalance").innerText = balFormatted + " U";
                document.getElementById("clickableBalance").innerText = balFormatted;

            } catch (err) {
                console.error("åˆ·æ–°æ•°æ®å¤±è´¥", err);
            }
        }

        // æ™ºèƒ½å­˜æ¬¾é€»è¾‘ (æ ¸å¿ƒå‡çº§)
        async function handleDeposit(type) {
            const inputVal = document.getElementById("depositAmount").value;
            if (!inputVal || inputVal <= 0) return showStatus("âŒ è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢", "error");
            
            const amountWei = ethers.parseUnits(inputVal, 18);
            
            // æ£€æŸ¥ä½™é¢
            if (amountWei > userBalanceWei) return showStatus("âŒ ä½™é¢ä¸è¶³ (Insufficient Balance)", "error");

            const btnId = type === 0 ? "btnSenior" : "btnJunior";
            setLoading(btnId, true, "å¤„ç†ä¸­...");

            try {
                // 1. æ£€æŸ¥æˆæƒ (Smart Approve)
                const currentAllowance = await usdtContract.allowance(userAddress, VAULT_ADDRESS);
                
                if (currentAllowance < amountWei) {
                    showStatus("â³ æ­£åœ¨è¯·æ±‚æˆæƒ (Approving)...", "loading");
                    const txApprove = await usdtContract.approve(VAULT_ADDRESS, amountWei);
                    await txApprove.wait();
                    showStatus("âœ… æˆæƒå®Œæˆï¼Œæ­£åœ¨å­˜æ¬¾...", "success");
                }

                // 2. æ‰§è¡Œå­˜æ¬¾
                showStatus("â³ æ­£åœ¨å­˜å…¥é‡‘åº“...", "loading");
                const txDeposit = await vaultContract.deposit(amountWei, type);
                await txDeposit.wait();

                showStatus("ğŸ‰ å­˜æ¬¾æˆåŠŸï¼(Deposit Success)", "success");
                document.getElementById("depositAmount").value = ""; // æ¸…ç©ºè¾“å…¥æ¡†
                await refreshData(); // åˆ·æ–°ä½™é¢

            } catch (err) {
                console.error(err);
                // èƒ½å¤Ÿè¯†åˆ«ç”¨æˆ·ç‚¹äº†â€œå–æ¶ˆâ€
                if (err.message.includes("rejected")) {
                    showStatus("âŒ ç”¨æˆ·å–æ¶ˆäº†æ“ä½œ", "error");
                } else {
                    showStatus("âŒ äº¤æ˜“å¤±è´¥: " + (err.reason || err.message), "error");
                }
            } finally {
                setLoading(btnId, false, type === 0 ? "å­˜å…¥ Senior" : "å­˜å…¥ Junior");
            }
        }

        async function handleWithdraw() {
            setLoading("btnWithdraw", true, "ææ¬¾ä¸­...");
            try {
                const tx = await vaultContract.withdraw();
                showStatus("â³ äº¤æ˜“ç¡®è®¤ä¸­...", "loading");
                await tx.wait();
                showStatus("ğŸ’° ææ¬¾æˆåŠŸï¼èµ„é‡‘å·²åˆ°è´¦", "success");
                await refreshData();
            } catch (err) {
                showStatus("âŒ " + (err.reason || "ææ¬¾å¤±è´¥æˆ–æœªåˆ°ç»“ç®—æœŸ"), "error");
            } finally {
                setLoading("btnWithdraw", false, "æå–æ‰€æœ‰èµ„é‡‘");
            }
        }

        async function handleCloseRound() {
            setLoading("btnClose", true, "ç»“ç®—ä¸­...");
            try {
                const tx = await vaultContract.closeRoundAndDistribute();
                showStatus("â³ æ­£åœ¨é“¾ä¸Šè®¡ç®—åˆ†çº¢...", "loading");
                await tx.wait();
                showStatus("âš¡ ç»“ç®—å®Œæˆï¼ç”¨æˆ·ç°å¯ææ¬¾", "success");
            } catch (err) {
                showStatus("âŒ " + (err.reason || "ç»“ç®—å¤±è´¥"), "error");
            } finally {
                setLoading("btnClose", false, "ğŸš¨ ç»“ç®—å‘¨æœŸ (Settlement)");
            }
        }

        // --- è¾…åŠ©å·¥å…· ---
        function formatUSDT(wei) {
            return parseFloat(ethers.formatUnits(wei, 18)).toFixed(2);
        }

        function fillMax() {
            if (userBalanceWei > 0n) {
                document.getElementById("depositAmount").value = ethers.formatUnits(userBalanceWei, 18);
            }
        }

        function showStatus(msg, type) {
            const el = document.getElementById("status");
            el.innerText = msg;
            el.className = `status-${type} status-show`;
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (el.innerText === msg) el.classList.remove("status-show");
            }, 5000);
        }

        function setLoading(btnId, isLoading, originalText) {
            const btn = document.getElementById(btnId);
            if (isLoading) {
                btn.classList.add("loading");
                btn.disabled = true;
                // ä¿æŒ spinnerï¼Œæ”¹æ–‡å­—
                btn.querySelector("span").innerText = originalText; 
            } else {
                btn.classList.remove("loading");
                btn.disabled = false;
                btn.querySelector("span").innerText = originalText;
            }
        }
    </script>
</body>
</html>